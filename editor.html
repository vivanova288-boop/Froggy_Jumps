<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Master Quest Builder 2026</title>
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #38bdf8; }
        body { margin: 0; display: flex; height: 100vh; font-family: 'Inter', sans-serif; background: var(--bg); color: #f1f5f9; overflow: hidden; }
        
        /* Интерфейс Редактора */
        #editor-panel { width: 420px; background: var(--panel); padding: 20px; overflow-y: auto; border-right: 2px solid #334155; box-shadow: 10px 0 15px rgba(0,0,0,0.3); z-index: 10; }
        .section { background: #0f172a; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #334155; }
        h2 { font-size: 14px; margin: 0 0 15px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        
        label { display: block; font-size: 11px; margin: 10px 0 5px; color: #94a3b8; }
        input, textarea, select { width: 100%; padding: 10px; background: #1e293b; border: 1px solid #475569; color: #fff; border-radius: 6px; box-sizing: border-box; font-size: 13px; }
        
        .row { display: flex; gap: 10px; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.3s; margin-top: 10px; text-transform: uppercase; }
        .btn-preview { background: #0ea5e9; color: white; }
        .btn-copy { background: #10b981; color: white; }
        .btn:hover { opacity: 0.8; transform: translateY(-2px); }

        /* Предпросмотр */
        #preview-box { flex: 1; display: flex; flex-direction: column; background: #000; position: relative; }
        iframe { flex: 1; border: none; width: 100%; height: 100%; }
        .preview-label { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); padding: 5px 10px; font-size: 10px; border-radius: 4px; pointer-events: none; }
    </style>
</head>
<body>

<div id="editor-panel">
    <div class="section">
        <h2>1. Графика и Герой</h2>
        <label>Персонаж (PNG):</label>
        <input type="file" id="f-hero" onchange="encode('hero', this)">
        <div class="row">
            <div><label>Размер (%)</label><input type="number" id="v-size" value="100"></div>
            <div><label>Прыжок (сек)</label><input type="text" id="v-speed" value="0.4"></div>
        </div>
        <label><input type="checkbox" id="v-glow" checked style="width:auto"> Добавить свечение</label>
        <label>Лист (платформа):</label><input type="file" onchange="encode('leaf', this)">
        <label>Фон (картинка):</label><input type="file" onchange="encode('bg', this)">
        <label>Жизнь (сердце):</label><input type="file" onchange="encode('life', this)">
    </div>

    <div class="section">
        <h2>2. Тексты и Таймер</h2>
        <label>Заголовок квеста:</label>
        <input type="text" id="v-title" value="LEVEL 1: PAST SIMPLE">
        <label>Вопросы (Вопрос|Верно|Нет|Нет):</label>
        <textarea id="v-questions" style="height:120px">I ___ to school.|went|go|gone
She ___ a cake.|made|make|maked
They ___ happy.|were|was|is</textarea>
        <label>Время на игру (сек):</label>
        <input type="number" id="v-time" value="60">
    </div>

    <div class="section">
        <h2>3. Аудио (7 слотов)</h2>
        <label>Выберите файлы сразу (1-7):</label>
        <input type="file" id="f-sounds" multiple onchange="encodeSounds(this)">
        <p style="font-size: 9px; color: #64748b;">1:Старт, 2:Прыжок, 3:Шок, 4:Финал, 5:Победа, 6:Уровень, 7:Тик</p>
    </div>

    <button class="btn btn-preview" onclick="updatePreview()">Обновить предпросмотр</button>
    <button class="btn btn-copy" onclick="copyCode()">Скопировать код Genially</button>
</div>

<div id="preview-box">
    <div class="preview-label">LIVE PREVIEW</div>
    <iframe id="target"></iframe>
</div>

<script>
    let store = { s: [] };

    function encode(key, input) {
        const reader = new FileReader();
        reader.onload = (e) => store[key] = e.target.result;
        reader.readAsDataURL(input.files[0]);
    }

    function encodeSounds(input) {
        Array.from(input.files).forEach((file, i) => {
            const reader = new FileReader();
            reader.onload = (e) => store.s[i] = e.target.result;
            reader.readAsDataURL(file);
        });
    }

    function buildEngine() {
        const title = document.getElementById('v-title').value;
        const speed = document.getElementById('v-speed').value;
        const size = document.getElementById('v-size').value;
        const glow = document.getElementById('v-glow').checked;
        const timeLimit = document.getElementById('v-time').value;

        const questionsRaw = document.getElementById('v-questions').value.split('\n').filter(l => l.includes('|'));
        const questJSON = JSON.stringify(questionsRaw.map(line => {
            const parts = line.split('|');
            const options = [parts[1], parts[2], parts[3]].sort(() => Math.random() - 0.5);
            return { q: parts[0], o: options, a: options.indexOf(parts[1]) };
        }));

        return `<!DOCTYPE html>
<html>
<head>
    <style>
        body { margin:0; background:url(${store.bg || ''}) center/cover no-repeat fixed #000; font-family:sans-serif; overflow:hidden; height:100vh; color:white; }
        #ui-top { position:fixed; top:0; width:100%; display:flex; justify-content:space-between; padding:15px; background:rgba(0,0,0,0.6); z-index:200; box-sizing:border-box; }
        #q-area { position:fixed; top:70px; left:50%; transform:translateX(-50%); width:80%; background:white; color:#333; padding:20px; border-radius:15px; text-align:center; font-weight:bold; z-index:200; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
        
        #hero { 
            position:absolute; width:${size}px; height:${size}px; 
            background:url(${store.hero || ''}) no-repeat center/contain; 
            transition: all ${speed}s cubic-bezier(0.4, 0, 0.2, 1); 
            z-index:100; transform: translate(-50%, -100%);
            ${glow ? 'filter: drop-shadow(0 0 15px #fff);' : ''}
        }
        
        .leaf { 
            position:absolute; width:120px; height:80px; 
            background:url(${store.leaf || ''}) no-repeat center/contain; 
            display:flex; align-items:center; justify-content:center; 
            padding:10px; box-sizing:border-box; text-align:center;
            font-size:13px; font-weight:bold; cursor:pointer; 
            transform: translate(-50%, -50%); text-shadow:1px 1px 2px #000;
        }

        #lives { display:flex; gap:5px; }
        .heart { width:25px; height:25px; background:url(${store.life || ''}) no-repeat center/contain; }
        
        .shock { animation: shake 0.1s infinite; filter: brightness(3) sepia(1); }
        @keyframes shake { 0%{margin-left:-10px} 100%{margin-left:10px} }
        
        #start-scr { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1000; cursor:pointer; }
    </style>
</head>
<body>
    <div id="start-scr" onclick="launch()"><h1>${title}</h1><p>КЛИКНИ ДЛЯ СТАРТА</p></div>
    
    <div id="ui-top">
        <div id="lives"></div>
        <div id="timer">${timeLimit}s</div>
    </div>

    <div id="q-area">Загрузка...</div>

    <div id="game-map" style="position:relative; width:100%; height:100%;">
        <div id="hero"></div>
        <div id="plat-container"></div>
    </div>

    <script>
        const quest = ${questJSON};
        const sounds = {
            start: new Audio("${store.s[0] || ''}"),
            jump: new Audio("${store.s[1] || ''}"),
            shock: new Audio("${store.s[2] || ''}"),
            end: new Audio("${store.s[3] || ''}")
        };

        let step = 0;
        let hp = 3;
        let lastPos = {x: 50, y: 88};

        function launch() {
            document.getElementById('start-scr').remove();
            sounds.start.play();
            updateHP();
            renderStep();
            move(50, 88);
        }

        function updateHP() {
            const container = document.getElementById('lives');
            container.innerHTML = '';
            for(let i=0; i<hp; i++) container.innerHTML += '<div class="heart"></div>';
        }

        function renderStep() {
            if(step >= quest.length) { sounds.end.play(); alert("ПОБЕДА!"); return; }
            
            document.getElementById('q-area').innerText = quest[step].q;
            const container = document.getElementById('plat-container');
            container.innerHTML = '';

            // Рисуем шахматную сетку из 15 уровней (всего пути)
            for(let r=0; r < quest.length; r++) {
                quest[r].o.forEach((txt, i) => {
                    const l = document.createElement('div');
                    l.className = 'leaf';
                    l.innerText = txt;
                    
                    // Шахматка: каждый ряд смещается
                    let x = (20 + i*30) + (r % 2 * 6);
                    let y = 85 - (r * 22); // Движение вверх по экрану

                    l.style.left = x + '%';
                    l.style.top = y + '%';
                    
                    if(r === step) {
                        l.onclick = () => handleJump(i, x, y);
                    } else {
                        l.style.opacity = (r < step) ? '0.2' : '0.5';
                    }
                    container.appendChild(l);
                });
            }
        }

        function handleJump(idx, tx, ty) {
            const h = document.getElementById('hero');
            h.style.left = tx + '%';
            h.style.top = ty + '%';

            if(idx === quest[step].a) {
                sounds.jump.play();
                lastPos = {x: tx, y: ty};
                step++;
                setTimeout(renderStep, 500);
            } else {
                sounds.shock.play();
                h.classList.add('shock');
                hp--;
                updateHP();
                setTimeout(() => {
                    h.classList.remove('shock');
                    move(lastPos.x, lastPos.y);
                    if(hp <= 0) { sounds.end.play(); alert("ИГРА ОКОНЧЕНА"); location.reload(); }
                }, 600);
            }
        }

        function move(x,y) {
            const h = document.getElementById('hero');
            h.style.left = x + '%'; h.style.top = y + '%';
        }
    <\/script>
</body>
</html>`;
    }

    function updatePreview() {
        const doc = buildEngine();
        const blob = new Blob([doc], {type: 'text/html'});
        document.getElementById('target').src = URL.createObjectURL(blob);
    }

    function copyCode() {
        const code = buildEngine();
        const iframe = `<iframe srcdoc='${code.replace(/'/g, "&apos;")}' width="100%" height="600" frameborder="0" allow="autoplay"></iframe>`;
        navigator.clipboard.writeText(iframe);
        alert("Код для Genially скопирован!");
    }
</script>
</body>
</html>
