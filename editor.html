<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Quest Editor Professional</title>
    <style>
        :root { --accent: #00d2ff; --bg: #121212; --panel: #1e1e1e; }
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; }
        
        /* Панель управления */
        #sidebar { width: 450px; background: var(--panel); padding: 25px; overflow-y: auto; border-right: 1px solid #333; }
        .group { background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-top: 3px solid var(--accent); }
        h2 { font-size: 14px; margin-top: 0; color: var(--accent); text-transform: uppercase; }
        
        label { display: block; font-size: 11px; margin: 10px 0 5px; color: #888; }
        input, textarea { width: 100%; padding: 10px; background: #000; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 100px; font-family: monospace; font-size: 12px; }

        .sound-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-preview { background: #555; color: white; }
        .btn-copy { background: var(--accent); color: #000; }
        .btn:hover { opacity: 0.8; transform: translateY(-2px); }

        /* Окно предпросмотра */
        #preview-area { flex: 1; display: flex; flex-direction: column; background: #000; }
        iframe { flex: 1; border: none; width: 100%; height: 100%; }
        .status { padding: 10px; font-size: 12px; background: #000; color: #444; text-align: center; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="group">
        <h2>1. Тексты и Логика</h2>
        <label>Заголовок (Level 1, и т.д.)</label>
        <input type="text" id="v-title" value="PAST SIMPLE CHALLENGE">
        <label>Вопросы (Вопрос|Верный|Ложный|Ложный)</label>
        <textarea id="v-questions">Yesterday I ___ my room.|cleaned|clean|cleans
She ___ to the park.|went|go|goes
They ___ happy.|were|was|is</textarea>
    </div>

    <div class="group">
        <h2>2. Графика (Загрузи свои PNG)</h2>
        <label>Герой:</label><input type="file" onchange="enc('hero', this)">
        <label>Платформа (Лист):</label><input type="file" onchange="enc('plat', this)">
        <label>Фон:</label><input type="file" onchange="enc('bg', this)">
        <label>Жизнь (Сердце):</label><input type="file" onchange="enc('life', this)">
    </div>

    <div class="group">
        <h2>3. Звуки (7 слотов)</h2>
        <div class="sound-list">
            <div><label>1. Splash:</label><input type="file" onchange="enc('s1', this)"></div>
            <div><label>2. Shock:</label><input type="file" onchange="enc('s2', this)"></div>
            <div><label>3. Win:</label><input type="file" onchange="enc('s3', this)"></div>
            <div><label>4. Game Over:</label><input type="file" onchange="enc('s4', this)"></div>
            <div><label>5. Start:</label><input type="file" onchange="enc('s5', this)"></div>
            <div><label>6. Level Up:</label><input type="file" onchange="enc('s6', this)"></div>
            <div><label>7. Timer:</label><input type="file" onchange="enc('s7', this)"></div>
        </div>
    </div>

    <button class="btn btn-preview" onclick="update()">ОБНОВИТЬ ПРЕДПРОСМОТР</button>
    <button class="btn btn-copy" onclick="copy()">СКОПИРОВАТЬ IFRAME ДЛЯ GENIALLY</button>
</div>

<div id="preview-area">
    <div class="status">ПРЕДПРОСМОТР РЕЗУЛЬТАТА</div>
    <iframe id="target"></iframe>
</div>

<script>
    let assets = {};

    function enc(k, i) {
        const r = new FileReader();
        r.onload = (e) => { assets[k] = e.target.result; };
        r.readAsDataURL(i.files[0]);
    }

 function build() {
    // Сбор данных из полей редактора
    const title = document.getElementById('v-title').value;
    const heroSize = document.getElementById('v-size')?.value || 80;
    const jumpSpeed = document.getElementById('v-speed')?.value || 0.3;
    const useGlow = document.getElementById('v-glow')?.checked;
    
    const raw = document.getElementById('v-questions').value.split('\n').filter(l => l.includes('|'));
    const qs = raw.map(l => {
        const p = l.split('|');
        const o = [p[1], p[2], p[3]]; // Сохраняем порядок или мешаем
        return { q: p[0], opt: o, ok: o.indexOf(p[1]) };
    });

    return `
<!DOCTYPE html>
<html>
<head>
    <style>
        body { margin:0; background:url(${assets.bg || ''}) center/cover no-repeat; font-family:sans-serif; overflow:hidden; height:100vh; }
        #header { position:fixed; top:0; width:100%; background:rgba(0,0,0,0.5); color:white; padding:10px; text-align:center; z-index:100; display:flex; justify-content:space-between; align-items:center; }
        #q-box { position:fixed; top:60px; left:50%; transform:translateX(-50%); background:white; width:60%; padding:15px; border-radius:30px; text-align:center; z-index:100; box-shadow:0 5px 15px rgba(0,0,0,0.3); font-weight:bold; }
        
        #hero { 
            position:absolute; width:${heroSize}px; height:${heroSize}px; 
            background:url(${assets.hero || ''}) no-repeat center/contain; 
            transition: all ${jumpSpeed}s ease-out; z-index:50; 
            transform: translate(-50%, -100%);
            ${useGlow ? 'filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));' : ''}
        }

        .leaf { 
            position:absolute; width:100px; height:70px; 
            background:url(${assets.plat || ''}) no-repeat center/contain; 
            display:flex; align-items:center; justify-content:center; 
            color:white; font-size:14px; font-weight:bold; cursor:pointer; 
            transform: translate(-50%, -50%); text-shadow: 1px 1px 2px #000;
        }

        .shock { animation: shk 0.1s infinite; filter: invert(1) brightness(2); }
        @keyframes shk { 0%{margin-left:-5px} 100%{margin-left:5px} }
        
        #timer-bar { position:absolute; bottom:0; left:0; height:5px; background:red; width:100%; transition:1s linear; }
        #start-screen { position:fixed; inset:0; background:rgba(0,0,0,0.8); color:white; display:flex; align-items:center; justify-content:center; z-index:1000; cursor:pointer; }
    </style>
</head>
<body>
    <div id="start-screen" onclick="start()"><h1>${title}<br>НАЧАТЬ</h1></div>
    <div id="header">
        <div id="lives-ui" style="margin-left:20px"></div>
        <div>${title}</div>
        <div id="timer-text" style="margin-right:20px">00:00</div>
    </div>
    <div id="q-box">Приготовься...</div>
    <div id="game-world" style="width:100%; height:100%; position:relative;">
        <div id="hero"></div>
        <div id="platforms"></div>
    </div>
    <div id="timer-bar"></div>

    <script>
        const quest = ${JSON.stringify(qs)};
        const s = { 
            st: new Audio("${assets.s5 || ''}"), j: new Audio("${assets.s2 || ''}"), 
            sh: new Audio("${assets.s3 || ''}"), f: new Audio("${assets.s4 || ''}") 
        };

        let step = 0;
        let lives = 3;
        let lastPos = {x: 50, y: 90};

        function start() {
            document.getElementById('start-screen').style.display='none';
            s.st.play();
            updateLives();
            initLevel();
        }

        function updateLives() {
            const div = document.getElementById('lives-ui');
            div.innerHTML = '❤️'.repeat(lives);
        }

        function initLevel() {
            const container = document.getElementById('platforms');
            container.innerHTML = '';
            moveHero(50, 90);
            
            document.getElementById('q-box').innerText = quest[step].q;

            // Рисуем сетку на 15 шагов вперед (или сколько есть вопросов)
            for(let i=0; i<quest.length; i++) {
                quest[i].opt.forEach((txt, idx) => {
                    const l = document.createElement('div');
                    l.className = 'leaf';
                    l.innerText = txt;
                    
                    // Расчет шахматного порядка
                    let xPos = 20 + (idx * 30) + (i % 2 * 5);
                    let yPos = 85 - (i * 20); // Продвижение вверх

                    l.style.left = xPos + '%';
                    l.style.top = yPos + '%';
                    
                    if(i === step) {
                        l.onclick = () => jumpTo(idx, xPos, yPos);
                    } else {
                        l.style.opacity = '0.4';
                    }
                    container.appendChild(l);
                });
            }
        }

        function jumpTo(idx, x, y) {
            const h = document.getElementById('hero');
            h.style.left = x + '%'; h.style.top = y + '%';

            if(idx === quest[step].ok) {
                s.j.play();
                lastPos = {x, y};
                step++;
                if(step >= quest.length) {
                    setTimeout(() => { s.f.play(); alert("ПОБЕДА!"); }, 500);
                } else {
                    setTimeout(initLevel, 500);
                }
            } else {
                s.sh.play();
                h.classList.add('shock');
                lives--; updateLives();
                setTimeout(() => {
                    h.classList.remove('shock');
                    moveHero(lastPos.x, lastPos.y);
                    if(lives <= 0) { s.f.play(); alert("ИГРА ОКОНЧЕНА"); location.reload(); }
                }, 600);
            }
        }

        function moveHero(x, y) {
            const h = document.getElementById('hero');
            h.style.left = x + '%'; h.style.top = y + '%';
        }
    <\/script>
</body>
</html>`;
}
