<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Quest Editor Professional</title>
    <style>
        :root { --accent: #00d2ff; --bg: #121212; --panel: #1e1e1e; }
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; }
        
        /* Панель управления */
        #sidebar { width: 450px; background: var(--panel); padding: 25px; overflow-y: auto; border-right: 1px solid #333; }
        .group { background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-top: 3px solid var(--accent); }
        h2 { font-size: 14px; margin-top: 0; color: var(--accent); text-transform: uppercase; }
        
        label { display: block; font-size: 11px; margin: 10px 0 5px; color: #888; }
        input, textarea { width: 100%; padding: 10px; background: #000; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 100px; font-family: monospace; font-size: 12px; }

        .sound-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-preview { background: #555; color: white; }
        .btn-copy { background: var(--accent); color: #000; }
        .btn:hover { opacity: 0.8; transform: translateY(-2px); }

        /* Окно предпросмотра */
        #preview-area { flex: 1; display: flex; flex-direction: column; background: #000; }
        iframe { flex: 1; border: none; width: 100%; height: 100%; }
        .status { padding: 10px; font-size: 12px; background: #000; color: #444; text-align: center; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="group">
        <h2>1. Тексты и Логика</h2>
        <label>Заголовок (Level 1, и т.д.)</label>
        <input type="text" id="v-title" value="PAST SIMPLE CHALLENGE">
        <label>Вопросы (Вопрос|Верный|Ложный|Ложный)</label>
        <textarea id="v-questions">Yesterday I ___ my room.|cleaned|clean|cleans
She ___ to the park.|went|go|goes
They ___ happy.|were|was|is</textarea>
    </div>

    <div class="group">
        <h2>2. Графика (Загрузи свои PNG)</h2>
        <label>Герой:</label><input type="file" onchange="enc('hero', this)">
        <label>Платформа (Лист):</label><input type="file" onchange="enc('plat', this)">
        <label>Фон:</label><input type="file" onchange="enc('bg', this)">
        <label>Жизнь (Сердце):</label><input type="file" onchange="enc('life', this)">
    </div>

    <div class="group">
        <h2>3. Звуки (7 слотов)</h2>
        <div class="sound-list">
            <div><label>1. Splash:</label><input type="file" onchange="enc('s1', this)"></div>
            <div><label>2. Shock:</label><input type="file" onchange="enc('s2', this)"></div>
            <div><label>3. Win:</label><input type="file" onchange="enc('s3', this)"></div>
            <div><label>4. Game Over:</label><input type="file" onchange="enc('s4', this)"></div>
            <div><label>5. Start:</label><input type="file" onchange="enc('s5', this)"></div>
            <div><label>6. Level Up:</label><input type="file" onchange="enc('s6', this)"></div>
            <div><label>7. Timer:</label><input type="file" onchange="enc('s7', this)"></div>
        </div>
    </div>

    <button class="btn btn-preview" onclick="update()">ОБНОВИТЬ ПРЕДПРОСМОТР</button>
    <button class="btn btn-copy" onclick="copy()">СКОПИРОВАТЬ IFRAME ДЛЯ GENIALLY</button>
</div>

<div id="preview-area">
    <div class="status">ПРЕДПРОСМОТР РЕЗУЛЬТАТА</div>
    <iframe id="target"></iframe>
</div>

<script>
    let assets = {};

    function enc(k, i) {
        const r = new FileReader();
        r.onload = (e) => { assets[k] = e.target.result; };
        r.readAsDataURL(i.files[0]);
    }

    function build() {
        const title = document.getElementById('v-title').value;
        const raw = document.getElementById('v-questions').value.split('\n').filter(l => l.includes('|'));
        const qs = raw.map(l => {
            const p = l.split('|');
            const o = [p[1], p[2], p[3]].sort(() => Math.random() - 0.5);
            return { q: p[0], opt: o, ok: o.indexOf(p[1]) };
        });

        return `
<!DOCTYPE html>
<html>
<head>
    <style>
        body { margin:0; background:url(${assets.bg || ''}) center/cover no-repeat fixed #000; font-family:sans-serif; overflow:hidden; }
        #ui { position:fixed; width:100%; top:0; z-index:100; text-align:center; }
        #header { background:rgba(0,0,0,0.7); color:white; padding:15px; font-size:22px; border-bottom:2px solid ${assets.bg ? 'transparent' : '#333'}; }
        #lives { position:absolute; top:70px; left:20px; display:flex; gap:5px; }
        .life { width:30px; height:30px; background:url(${assets.life || ''}) no-repeat center/contain; }
        #q-box { background:white; width:85%; margin:20px auto; padding:20px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
        #hero { position:absolute; width:80px; height:80px; background:url(${assets.hero || ''}) no-repeat center/contain; transform:translate(-50%,-100%); transition:0.5s; z-index:50; }
        .leaf { position:absolute; width:130px; height:90px; background:url(${assets.plat || ''}) no-repeat center/contain; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; cursor:pointer; text-shadow:1px 1px 2px #000; transform:translate(-50%,-50%); }
        .shock { animation: shk 0.1s infinite; filter: brightness(2) sepia(1); }
        @keyframes shk { 0%{margin-left:-5px} 100%{margin-left:5px} }
        #start { position:fixed; inset:0; background:rgba(0,0,0,0.9); color:${assets.hero ? 'white' : '#00d2ff'}; display:flex; align-items:center; justify-content:center; z-index:1000; cursor:pointer; }
    </style>
</head>
<body>
    <div id="start" onclick="begin()"><h1>START GAME</h1></div>
    <div id="ui">
        <div id="header">${title}</div>
        <div id="lives"></div>
        <div id="q-box">...</div>
    </div>
    <div id="world" style="height:100vh; position:relative; margin-top:100px;">
        <div id="hero"></div>
    </div>

    <script>
        const quest = ${JSON.stringify(qs)};
        const s = { 
            j: new Audio("${assets.s1 || ''}"), sh: new Audio("${assets.s2 || ''}"), 
            w: new Audio("${assets.s3 || ''}"), f: new Audio("${assets.s4 || ''}"), 
            st: new Audio("${assets.s5 || ''}"), lv: new Audio("${assets.s6 || ''}") 
        };
        let step = 0; let lives = 3; let lastPos = {x: 50, y: 85};

        function begin() {
            document.getElementById('start').style.display='none';
            s.st.play();
            updateLives();
            moveHero(50, 85);
            load();
        }

        function moveHero(x, y) {
            const h = document.getElementById('hero');
            h.style.left = x + '%'; h.style.top = y + '%';
        }

        function updateLives() {
            const container = document.getElementById('lives');
            container.innerHTML = '';
            for(let i=0; i<lives; i++) container.innerHTML += '<div class="life"></div>';
        }

        function load() {
            if(step >= quest.length) { s.w.play(); alert("Победа!"); return; }
            document.getElementById('q-box').innerText = quest[step].q;
            const world = document.getElementById('world');
            document.querySelectorAll('.leaf').forEach(l => l.remove());
            
            quest[step].opt.forEach((t, i) => {
                const l = document.createElement('div');
                l.className = 'leaf'; l.innerText = t;
                l.style.left = (20 + i*30) + '%'; l.style.top = '45%';
                l.onclick = () => jump(i, 20 + i*30, 45);
                world.appendChild(l);
            });
        }

        function jump(idx, x, y) {
            const h = document.getElementById('hero');
            moveHero(x, y);
            if(idx === quest[step].ok) {
                s.j.play(); lastPos = {x, y};
                setTimeout(() => { step++; load(); }, 600);
            } else {
                s.sh.play();
                h.classList.add('shock');
                lives--; updateLives();
                setTimeout(() => {
                    h.classList.remove('shock');
                    moveHero(lastPos.x, lastPos.y);
                    if(lives <= 0) { s.f.play(); alert("Игра окончена"); location.reload(); }
                }, 600);
            }
        }
    <\/script>
</body>
</html>`;
    }

    function update() { document.getElementById('target').srcdoc = build(); }
    function copy() {
        const iframe = `<iframe srcdoc='${build().replace(/'/g, "&apos;")}' width="100%" height="600" frameborder="0" allow="autoplay"></iframe>`;
        navigator.clipboard.writeText(iframe);
        alert("Код скопирован! Вставь его в Genially (Вставка -> Другое)");
    }
</script>
</body>
</html>
