<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Froggy Jumps</title>
    <style>
        body, html { margin:0; padding:0; height:100%; width:100%; overflow:hidden; font-family:sans-serif; background:#1e3799; }
        
        /* СТАРТОВЫЙ ЭКРАН */
        #start-screen { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; }
        #btn-go { padding:20px 60px; font-size:28px; font-weight:bold; background:#4cd137; color:white; border:none; border-radius:50px; cursor:pointer; box-shadow:0 10px 20px rgba(0,0,0,0.4); }
        
        /* ОБРАТНЫЙ ОТСЧЕТ */
        #timer-screen { position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:9000; display:none; align-items:center; justify-content:center; color:#fff; font-size:150px; font-weight:bold; }

        #gm { width:100%; height:100%; position:relative; display:none; background-size:cover; background-position:center; }
        #q-card { position:absolute; top:50px; left:50%; transform:translateX(-50%); background:#fff; border-radius:20px; padding:15px; width:60%; text-align:center; z-index:100; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
        #tm-bg { width:100%; height:8px; background:#eee; border-radius:4px; margin-top:10px; overflow:hidden; }
        #tm-f { height:100%; width:100%; background:#e84118; transition:linear; }

        #frog { width:80px; height:80px; position:absolute; z-index:500; transition:0.6s cubic-bezier(.47,1.21,.58,1); background-size:contain; background-repeat:no-repeat; }
        
        .leaf { position:absolute; width:120px; height:90px; background-size:contain; background-repeat:no-repeat; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; font-weight:bold; font-size:14px; text-shadow:1px 1px 2px #000; transition:0.3s; padding-top:10px; }
        .leaf-active { cursor:pointer; opacity:1; }
        .leaf-idle { opacity:0.4; cursor:default; }
        .letter { position:absolute; top:-15px; background:#f1c40f; color:#000; border-radius:50%; width:22px; height:22px; display:flex; align-items:center; justify-content:center; border:2px solid #fff; font-size:12px; }
        
        .shock { animation: shake 0.1s infinite; filter: brightness(2) contrast(1.5) hue-rotate(180deg); }
        @keyframes shake { 0%, 100% { transform:translate(0); } 25% { transform:translate(4px); } 75% { transform:translate(-4px); } }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 id="title">FROGGY JUMPS</h1>
        <button id="btn-go" onclick="launch()">ИГРАТЬ</button>
    </div>

    <div id="timer-screen">3</div>

    <div id="gm">
        <div id="q-card">
            <div id="q-txt" style="font-size:20px; color:#2f3640;">Загрузка...</div>
            <div id="tm-bg"><div id="tm-f"></div></div>
        </div>
        <div id="pond"></div>
        <div id="frog"></div>
    </div>

<script>
    let c, step=0, hp, lastPos={x:50,y:85}, aud={}, timer;
    const params = new URLSearchParams(window.location.search);
    const data = params.get('d');

    if(data) {
        try { 
            c = JSON.parse(decodeURIComponent(data));
            document.getElementById('title').innerText = c.t;
        } catch(e) { console.error("Data error"); }
    }

    function launch() {
        document.getElementById('start-screen').style.display = 'none';
        const ts = document.getElementById('timer-screen');
        ts.style.display = 'flex';
        
        // Инициализация звука
        c.s.forEach((u,i)=> { if(u) { aud[i]=new Audio(u); aud[i].volume=c.vol; } });

        let count = 3;
        let itv = setInterval(() => {
            count--;
            if(count > 0) ts.innerText = count;
            else {
                clearInterval(itv);
                ts.style.display = 'none';
                document.getElementById('gm').style.display = 'block';
                document.getElementById('gm').style.backgroundImage = `url(${c.bg})`;
                document.getElementById('frog').style.backgroundImage = `url(${c.fr})`;
                hp = c.li; 
                if(aud[0]) aud[0].play();
                drawWorld();
                moveFrog(50, 85);
                startQuestion();
            }
        }, 1000);
    }

    function drawWorld() {
        const pond = document.getElementById('pond');
        pond.innerHTML = '';
        // Рисуем сетку 5 рядов по 3 листика сразу
        for(let r=0; r<5; r++) {
            for(let i=0; i<3; i++) {
                const l = document.createElement('div');
                l.id = `l-${r}-${i}`;
                l.className = 'leaf leaf-idle';
                l.style.backgroundImage = `url(${c.le})`;
                l.style.left = (20 + i*30) + '%';
                l.style.top = (80 - r*15) + '%';
                l.innerHTML = `<div class="letter">${String.fromCharCode(65+i)}</div><span class="txt"></span>`;
                pond.appendChild(l);
            }
        }
    }

    function startQuestion() {
        if(step >= c.qs.length) { if(aud[3]) aud[3].play(); alert(c.win); return; }
        clearInterval(timer);
        
        const q = c.qs[step];
        document.getElementById('q-txt').innerText = q.q;
        
        const row = step % 5;
        // Очищаем старые листики
        document.querySelectorAll('.leaf').forEach(el => {
            el.className = 'leaf leaf-idle';
            el.onclick = null;
            el.querySelector('.txt').innerText = '';
        });

        // Активируем текущий ряд
        let options = q.o.map((t, idx) => ({t, ok: idx===0}));
        options.sort(() => Math.random() - 0.5);

        options.forEach((opt, i) => {
            const el = document.getElementById(`l-${row}-${i}`);
            el.className = 'leaf leaf-active';
            el.querySelector('.txt').innerText = opt.t;
            el.onclick = () => handleJump(opt.ok, 20 + i*30, 80 - row*15);
        });

        if(c.tme) startTimer();
    }

    function handleJump(isOk, x, y) {
        moveFrog(x, y);
        if(isOk) {
            if(aud[1]) aud[1].play();
            lastPos = {x, y};
            step++;
            setTimeout(startQuestion, 700);
        } else {
            if(aud[2]) aud[2].play();
            const f = document.getElementById('frog');
            f.classList.add('shock'); // Механика шока [cite: 2026-01-18]
            hp--;
            setTimeout(() => {
                f.classList.remove('shock');
                moveFrog(lastPos.x, lastPos.y); // Возврат [cite: 2026-01-18]
                if(hp <= 0) { if(aud[4]) aud[4].play(); alert(c.lose); location.reload(); }
            }, 800);
        }
    }

    function startTimer() {
        let w = 100;
        const f = document.getElementById('tm-f');
        timer = setInterval(() => {
            w -= 100/(c.tm*10);
            f.style.width = w + '%';
            if(w <= 0) { clearInterval(timer); if(aud[4]) aud[4].play(); alert(c.lose); location.reload(); }
        }, 100);
    }

    function moveFrog(x, y) {
        const f = document.getElementById('frog');
        f.style.left = `calc(${x}% - 40px)`;
        f.style.top = `calc(${y}% - 40px)`;
    }
</script>
</body>
</html>
