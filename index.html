<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        :root { --clr: #6ab04c; --speed: 0.7s; }
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #e0f7fa; }
        #game { width: 100vw; height: 100vh; position: relative; background-size: cover; display: none; }
        #header { height: 50px; background: var(--clr); color: white; display: flex; align-items: center; justify-content: space-around; font-weight: bold; }
        #q-box { position: absolute; top: 70px; width: 90%; left: 5%; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #timer-bar { position: absolute; top: 135px; width: 90%; left: 5%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; }
        #timer-fill { height: 100%; background: #ff4757; width: 100%; transition: width 0.1s linear; }
        #ans-zone { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 40px; }
        .lily { width: 100px; height: 60px; background-size: contain; background-repeat: no-repeat; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; padding-bottom: 10px; }
        #frog { width: 80px; position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); transition: all var(--speed) ease; z-index: 10; }
        .shock { animation: shake 0.1s infinite; filter: invert(1) sepia(1) saturate(10) hue-rotate(180deg); }
        @keyframes shake { 0% { margin-left: -5px; } 100% { margin-left: 5px; } }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; font-size: 40px; }
        .heart { width: 30px; height: 30px; background-size: contain; background-repeat: no-repeat; display: inline-block; margin: 0 2px; }
    </style>
</head>
<body>
    <div id="overlay">ОЖИДАНИЕ...</div>
    <div id="game">
        <div id="header">
            <div id="title">FROGGY</div>
            <div id="life-container"></div>
            <div id="lvl-info">LVL 1</div>
        </div>
        <div id="q-box"></div>
        <div id="timer-bar"><div id="timer-fill"></div></div>
        <img id="frog" src="">
        <div id="ans-zone"></div>
    </div>

<script>
let cfg, curQ = 0, curLvl = 1, lives, timer, timeLimit, bgSnd;

window.onload = () => window.parent.postMessage('ready', '*');
window.addEventListener('message', e => { if(e.data.questions) { cfg = e.data; init(); }});

function init() {
    document.body.style.setProperty('--clr', cfg.clr);
    document.body.style.setProperty('--speed', cfg.speed);
    document.getElementById('game').style.backgroundImage = `url(${cfg.img.bg})`;
    document.getElementById('frog').src = cfg.img.frog;
    document.getElementById('q-box').style.fontSize = cfg.fs + 'px';
    lives = parseInt(cfg.lives);
    countdown();
}

function countdown() {
    let count = 3;
    const ov = document.getElementById('overlay');
    play(cfg.snd.s2);
    let int = setInterval(() => {
        ov.innerText = count > 0 ? count : "GO!";
        if(count < 0) {
            clearInterval(int);
            ov.style.display = 'none';
            document.getElementById('game').style.display = 'block';
            startBg();
            render();
        }
        count--;
    }, 1000);
}

function startBg() {
    if(!cfg.snd.on) return;
    bgSnd = new Audio(cfg.snd.s1);
    bgSnd.loop = true;
    bgSnd.volume = cfg.snd.v;
    bgSnd.play();
}

function render() {
    updateUI();
    let q = cfg.questions[curQ];
    document.getElementById('q-box').innerText = q.q;
    let zone = document.getElementById('ans-zone');
    zone.innerHTML = '';
    
    let answers = q.a.map((text, i) => ({ text, ok: i === q.c }));
    if(cfg.shuf) answers.sort(() => Math.random() - 0.5);

    answers.forEach(ans => {
        let l = document.createElement('div');
        l.className = 'lily';
        l.style.backgroundImage = `url(${cfg.img.leaf})`;
        l.innerText = ans.text;
        l.onclick = () => check(ans.ok, l);
        zone.appendChild(l);
    });
    startTimer();
}

function check(ok, el) {
    const f = document.getElementById('frog');
    const rect = el.getBoundingClientRect();
    f.style.left = (rect.left + rect.width/2) + 'px';
    f.style.bottom = '100px';

    if(ok) {
        play(cfg.snd.s3);
        clearInterval(timer);
        setTimeout(() => {
            curQ++;
            if(curQ % cfg.qpl === 0) nextLevel();
            else { resetFrog(); render(); }
        }, 800);
    } else {
        play(cfg.snd.s4);
        f.classList.add('shock');
        lives--;
        setTimeout(() => {
            f.classList.remove('shock');
            resetFrog();
            if(lives <= 0) endGame(false);
        }, 600);
    }
}

function nextLevel() {
    play(cfg.snd.s7);
    const f = document.getElementById('frog');
    f.style.bottom = '1000px'; // "Супер-прыжок"
    setTimeout(() => {
        curLvl++;
        if(curQ >= cfg.questions.length) endGame(true);
        else { resetFrog(); render(); }
    }, 1000);
}

function startTimer() {
    if(!cfg.tmOn) return;
    clearInterval(timer);
    timeLimit = cfg.time;
    let current = timeLimit;
    timer = setInterval(() => {
        current -= 0.1;
        document.getElementById('timer-fill').style.width = (current/timeLimit)*100 + '%';
        if(current <= 0) { clearInterval(timer); endGame(false); }
    }, 100);
}

function updateUI() {
    document.getElementById('lvl-info').innerText = `LVL ${curLvl}`;
    let h = '';
    for(let i=0; i<lives; i++) h += `<div class="heart" style="background-image:url(${cfg.img.heart})"></div>`;
    document.getElementById('life-container').innerHTML = h;
}

function resetFrog() {
    const f = document.getElementById('frog');
    f.style.left = '50%';
    f.style.bottom = '50px';
}

function play(u) { if(cfg.snd.on) { let a = new Audio(u); a.volume = cfg.snd.v; a.play(); }}

function endGame(win) {
    clearInterval(timer);
    if(bgSnd) bgSnd.pause();
    play(win ? cfg.snd.s5 : cfg.snd.s6);
    const ov = document.getElementById('overlay');
    ov.style.display = 'flex';
    ov.innerHTML = `<div>${win ? cfg.fin.w : cfg.fin.l}</div>`;
    if(cfg.fin.r) {
        let b = document.createElement('button');
        b.innerText = "RETRY";
        b.onclick = () => location.reload();
        ov.appendChild(b);
    }
}
</script>
</body>
</html>
