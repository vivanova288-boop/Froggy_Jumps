<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Froggy Quest</title>
    <style>
        :root { --ui-bg: #6ab04c; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: Arial, sans-serif; background-color: #222; }
        #bg-layer { position: fixed; inset: 0; background-size: cover; background-position: center; z-index: -1; }
        
        #entry-gate { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
        #entry-gate button { padding: 15px 40px; font-size: 20px; cursor: pointer; background: var(--ui-bg); border: none; border-radius: 30px; color: white; font-weight: bold; margin-top: 20px; }

        #ui-layer { position: absolute; top: 0; width: 100%; z-index: 1000; }
        #header { background: var(--ui-bg); color: white; padding: 10px; text-align: center; font-weight: bold; }
        #lives-container { position: absolute; top: 50px; left: 20px; display: flex; gap: 8px; }
        .life-icon { width: 40px; height: 40px; background-size: contain; background-repeat: no-repeat; }

        #question-box { background: white; width: 85%; max-width: 500px; margin: 10px auto; padding: 15px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .timer-bar { width: 100%; height: 6px; background: #eee; border-radius: 3px; margin-top: 10px; overflow: hidden; }
        #timer-fill { width: 100%; height: 100%; background: #ff4757; transition: width 0.1s linear; }

        #world { position: absolute; inset: 0; padding-top: 100px; }
        #pond { position: relative; width: 100%; height: 100%; transition: 1s; }
        .leaf { position: absolute; width: 120px; height: 100px; background-size: contain; background-repeat: no-repeat; background-position: center; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; text-shadow: 1px 1px 2px #000; font-size: 14px; cursor: pointer; transition: 0.3s; padding: 10px; box-sizing: border-box; }
        
        #frog { position: absolute; width: 70px; height: 70px; background-size: contain; background-repeat: no-repeat; background-position: center; z-index: 99; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; transform: translate(-50%, -50%); }
        .shock { animation: shock-anim 0.1s infinite; filter: brightness(2) hue-rotate(90deg) !important; }
        @keyframes shock-anim { 0% { margin-left: 2px; } 100% { margin-left: -2px; } }

        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 9999; }
    </style>
</head>
<body>

<div id="bg-layer"></div>
<div id="entry-gate"><h1 id="start-title">LOADING...</h1><button onclick="startGame()">ИГРАТЬ</button></div>

<div id="ui-layer">
    <div id="header">LEVEL 1</div>
    <div id="lives-container"></div>
    <div id="question-box">
        <div id="q-text">Вопрос...</div>
        <div class="timer-bar"><div id="timer-fill"></div></div>
    </div>
</div>

<div id="world"><div id="pond"><div id="frog"></div></div></div>

<div id="overlay">
    <h1 id="end-msg">FINISH</h1>
    <button onclick="location.reload()">Еще раз</button>
</div>

<script>
// Настройки по умолчанию
let config = {
    t: "FROGGY QUEST", li: 5, tm: 15, tme: true,
    bg: "bg.png", fr: "2.png", le: "1.png", ic: "3.png",
    vol: 0.5,
    s: ["5.mp3", "1.mp3", "2.mp3", "3.mp3", "4.mp3", "6.mp3", "7.mp3"],
    qs: [{q: "2+2?", o: ["4", "5", "6"], correct: 0}]
};

// ЧИТАЕМ ДАННЫЕ ИЗ ССЫЛКИ
const params = new URLSearchParams(window.location.search);
if(params.has('d')) {
    try {
        config = JSON.parse(decodeURIComponent(params.get('d')));
    } catch(e) { console.error("Ошибка парсинга конфига"); }
}

// Применяем визуал
document.getElementById('start-title').innerText = config.t;
document.getElementById('bg-layer').style.backgroundImage = `url('${config.bg}')`;
document.getElementById('frog').style.backgroundImage = `url('${config.fr}')`;

let currentStep = 0, lives = config.li, timerItv;
const sounds = config.s.map(src => new Audio(src));

function playSnd(id) { 
    const a = sounds[id]; 
    if(a) { a.volume = config.vol; a.currentTime = 0; a.play().catch(()=>{}); } 
}

function startGame() {
    document.getElementById('entry-gate').style.display = 'none';
    playSnd(0); // Звук отсчета/старта
    initLevel();
}

function initLevel() {
    const pond = document.getElementById('pond');
    pond.querySelectorAll('.leaf').forEach(n => n.remove());
    
    if(currentStep >= config.qs.length) {
        showEnd("ПОБЕДА!", 3);
        return;
    }

    const q = config.qs[currentStep];
    document.getElementById('q-text').innerText = q.q;
    document.getElementById('header').innerText = `${config.t} | ${currentStep + 1}/${config.qs.length}`;
    
    // Создаем лилии
    q.o.forEach((text, i) => {
        const leaf = document.createElement('div');
        leaf.className = 'leaf';
        leaf.style.backgroundImage = `url('${config.le}')`;
        leaf.style.left = (20 + i * 30) + '%';
        leaf.style.top = '60%';
        leaf.innerText = text;
        leaf.onclick = () => handleAnswer(i, leaf);
        pond.appendChild(leaf);
    });

    updateLives();
    if(config.tme) startTimer();
}

function handleAnswer(idx, el) {
    const frog = document.getElementById('frog');
    frog.style.left = el.offsetLeft + (el.offsetWidth/2) + 'px';
    frog.style.top = el.offsetTop + (el.offsetHeight/2) + 'px';

    clearInterval(timerItv);

    if(idx === 0) { // В твоем массиве правильный всегда первый (редактор так шлет)
        playSnd(1); // Всплеск
        setTimeout(() => {
            currentStep++;
            if(currentStep < config.qs.length) playSnd(5); // Переход
            initLevel();
        }, 800);
    } else {
        playSnd(2); // Шок
        frog.classList.add('shock');
        lives--;
        updateLives();
        setTimeout(() => {
            frog.classList.remove('shock');
            if(lives <= 0) showEnd("ИГРА ОКОНЧЕНА", 4);
            else initLevel();
        }, 800);
    }
}

function updateLives() {
    const cont = document.getElementById('lives-container');
    cont.innerHTML = '';
    for(let i=0; i<lives; i++) {
        const icon = document.createElement('div');
        icon.className = 'life-icon';
        icon.style.backgroundImage = `url('${config.ic}')`;
        cont.appendChild(icon);
    }
}

function startTimer() {
    let t = 100;
    timerItv = setInterval(() => {
        t -= (100 / (config.tm * 10));
        document.getElementById('timer-fill').style.width = t + '%';
        if(t <= 0) { clearInterval(timerItv); showEnd("ВРЕМЯ ВЫШЛО", 4); }
    }, 100);
}

function showEnd(msg, sndIdx) {
    playSnd(sndIdx);
    document.getElementById('end-msg').innerText = msg;
    document.getElementById('overlay').style.display = 'flex';
}
</script>
</body>
</html>
