<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Froggy Jumps - Local Edition</title>
<style>
    /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –∏–∑ —Ç–≤–æ–µ–≥–æ –∫–æ–¥–∞ */
    :root { --water1: #2bbcd6; --water2: #168ea0; --ui-bg: #6ab04c; }
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: Arial, sans-serif; background: #2c3e50; color: white; }
    
    /* –ó–∞—Å—Ç–∞–≤–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ */
    #setup-screen { position: fixed; inset: 0; background: #34495e; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    .upload-box { background: #2c3e50; padding: 30px; border-radius: 20px; border: 2px dashed #6ab04c; max-width: 400px; }
    
    #game-stage { display: none; width: 100%; height: 100%; position: relative; }
    #bg-layer { position: absolute; inset: 0; background-size: cover; background-position: center; z-index: -1; }

    /* UI Layer */
    #ui-layer { position: absolute; top: 0; width: 100%; z-index: 1000; pointer-events: none; }
    #header { background: var(--ui-bg); color: white; padding: 10px; text-align: center; font-weight: bold; pointer-events: auto; }
    #lives-container { position: absolute; top: 50px; left: 20px; display: flex; gap: 8px; pointer-events: auto; }
    .life-icon { width: 52px; height: 52px; background-size: contain; background-repeat: no-repeat; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
    #question-box { background: white; color: #333; width: 85%; max-width: 500px; margin: 10px auto; padding: 12px; border-radius: 18px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.25); pointer-events: auto; }
    .timer-bar { width: 100%; height: 8px; background: #dfe6e9; border-radius: 5px; margin-top: 8px; overflow: hidden; }
    #timer-fill { width: 100%; height: 100%; background: #eb4d4b; transition: width 0.1s linear; }

    /* World & Frog */
    #world { position: absolute; inset: 0; padding-top: 60px; overflow: hidden; }
    #pond { position: relative; width: 100%; height: 100%; }
    .leaf { position: absolute; width: 20vw; height: 16vw; max-width: 180px; max-height: 150px; background-size: contain; background-repeat: no-repeat; display: flex; align-items: center; justify-content: center; transform: scale(0.85); transition: transform 0.4s, opacity 0.4s; padding: 15px; box-sizing: border-box; text-align: center; font-size: 20px; color: white; font-weight: bold; text-shadow: 1px 1px 3px #000; }
    .leaf.active { transform: scale(1.1); cursor: pointer; filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.9)); }
    
    #frog { position: absolute; width: 10vw; height: 10vw; max-width: 90px; max-height: 90px; background-size: contain; background-repeat: no-repeat; transform: translate(-50%, -60%) scale(1.15); filter: drop-shadow(0 10px 15px rgba(0,0,0,0.4)); z-index: 999; transition: left 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275), top 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; opacity: 0; }
    
    /* Animations */
    .shock { animation: electric-shock 0.1s infinite; z-index: 20 !important; }
    @keyframes electric-shock { 0% { filter: brightness(2) hue-rotate(180deg); transform: translate(-50%, -60%) scale(1.2) rotate(5deg); } 100% { filter: brightness(1); transform: translate(-50%, -60%) scale(1.1) rotate(-5deg); } }
    .jumping-frog { transform: translate(-50%, -80%) scale(1.4) !important; }
    .super-jump { top: -200px !important; transform: translate(-50%, -50%) scale(2) rotate(360deg) !important; transition: top 0.8s ease-in, transform 0.8s !important; }
    .pond-transition { animation: pond-slide 1.2s ease-in-out; }
    @keyframes pond-slide { 0% { transform: translateY(0); } 50% { transform: translateY(100vh); opacity: 0; } 51% { transform: translateY(-100vh); } 100% { transform: translateY(0); opacity: 1; } }

    /* Overlay */
    #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 5000; }
    #msg { font-size: 60px; color: #ffcc00; text-shadow: 0 0 20px #ff4500; text-align: center; }
    #fireworksCanvas { position: absolute; inset: 0; pointer-events: none; display: none; }
    .btn { padding: 15px 40px; background: var(--ui-bg); border: none; color: white; border-radius: 30px; cursor: pointer; font-size: 20px; font-weight: bold; margin-top: 20px; }
</style>
</head>
<body>

    <div id="setup-screen">
        <div class="upload-box">
            <h2>üê∏ –ó–∞–≥—Ä—É–∑–∫–∞ –ö–≤–µ—Å—Ç–∞</h2>
            <p>1. –í—ã–±–µ—Ä–∏ <b>config.json</b></p>
            <input type="file" id="config-file" accept=".json">
            <p>2. –í—ã–±–µ—Ä–∏ <b>–í–°–ï</b> –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∏ –∑–≤—É–∫–∏</p>
            <input type="file" id="asset-files" multiple>
            <br><br>
            <button class="btn" onclick="processFiles()">–ü–û–ï–•–ê–õ–ò!</button>
        </div>
    </div>

    <div id="game-stage">
        <div id="bg-layer"></div>
        <div id="ui-layer">
            <div id="header">FROGGY CHALLENGE</div>
            <div id="lives-container"></div>
            <div id="question-box">
                <div id="q-text">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
                <div class="timer-bar"><div id="timer-fill"></div></div>
            </div>
        </div>
        <div id="world">
            <div id="pond"><div id="frog"></div></div>
        </div>
        <div id="overlay">
            <canvas id="fireworksCanvas"></canvas>
            <h1 id="msg"></h1>
            <button class="btn" onclick="location.reload()">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
        </div>
    </div>

    <div id="countdown-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:3000; justify-content:center; align-items:center;">
        <div id="countdown-text" style="font-size:150px; font-weight:bold; color:white;"></div>
    </div>

<script>
let config = {}, assets = {}, questions = [], step = 0, lives = 5, currentLevel = 1;
let timer, lastCorrectLeaf, sounds = {};

async function processFiles() {
    const configFile = document.getElementById('config-file').files[0];
    const assetFiles = document.getElementById('asset-files').files;
    if(!configFile || assetFiles.length === 0) return alert("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—Å–µ —Ñ–∞–π–ª—ã!");

    // –ß–∏—Ç–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    config = JSON.parse(await configFile.text());
    
    // –°–æ–∑–¥–∞–µ–º Blob-—Å—Å—ã–ª–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
    for(let f of assetFiles) { assets[f.name] = URL.createObjectURL(f); }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–≤—É–∫–∏ –ø–æ –∏–º–µ–Ω–∞–º –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º
    const sMap = config.snd || { start:'5.mp3', splash:'1.mp3', shock:'2.mp3', win:'3.mp3', fail:'4.mp3', level:'6.mp3', count:'7.mp3' };
    for(let key in sMap) { sounds[key] = new Audio(assets[sMap[key]]); }

    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('game-stage').style.display = 'block';
    
    initGame();
}

function playSnd(audio) { 
    if(audio) { audio.currentTime = 0; audio.play().catch(() => {}); } 
}

function updateFrog(leaf) {
    const f = document.getElementById('frog');
    f.classList.add('jumping-frog');
    f.style.left = (leaf.offsetLeft + leaf.offsetWidth / 2) + 'px';
    f.style.top = (leaf.offsetTop + leaf.offsetHeight / 2) + 'px';
    setTimeout(() => f.classList.remove('jumping-frog'), 600);
}

function createPond() {
    const pond = document.getElementById('pond');
    const frog = document.getElementById('frog');
    pond.innerHTML = ''; pond.appendChild(frog);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏
    document.getElementById('bg-layer').style.backgroundImage = `url(${assets[config.files.bg]})`;
    frog.style.backgroundImage = `url(${assets[config.files.fr]})`;

    for (let r = 0; r < 7; r++) {
        for (let c = 1; c < 4; c++) {
            const leaf = document.createElement('div');
            leaf.className = 'leaf';
            leaf.id = `leaf-${r}-${c}`;
            leaf.style.backgroundImage = `url(${assets[config.files.le]})`;
            leaf.style.left = (25 + (c-1) * 25) + '%';
            leaf.style.top = (15 + r * 11) + '%';
            pond.appendChild(leaf);
        }
    }
}

function initGame() {
    lives = 5; step = 0; currentLevel = 1;
    updateLives();
    createPond();
    
    // –û—Ç—Å—á–µ—Ç 3-2-1
    const overlay = document.getElementById('countdown-overlay');
    const txt = document.getElementById('countdown-text');
    overlay.style.display = 'flex';
    playSnd(sounds.count);
    
    let c = 3;
    const int = setInterval(() => {
        txt.innerText = c > 0 ? c : "GO!";
        if(c < 0) {
            clearInterval(int);
            overlay.style.display = 'none';
            document.getElementById('frog').style.opacity = 1;
            startGameLogic();
        }
        c--;
    }, 1000);
}

function updateLives() {
    const container = document.getElementById('lives-container');
    container.innerHTML = '';
    for(let i=0; i<lives; i++) {
        const h = document.createElement('div');
        h.className = 'life-icon';
        h.style.backgroundImage = `url(${assets[config.files.ic]})`;
        container.appendChild(h);
    }
}

function startGameLogic() {
    playSnd(sounds.start);
    lastCorrectLeaf = document.getElementById('leaf-6-2');
    updateFrog(lastCorrectLeaf);
    loadLevel();
}

function loadLevel() {
    if (step >= 6) { // –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω
        const f = document.getElementById('frog');
        f.classList.add('super-jump');
        playSnd(sounds.level);
        setTimeout(() => {
            document.getElementById('pond').classList.add('pond-transition');
            setTimeout(() => {
                step = 0; currentLevel++;
                document.getElementById('pond').classList.remove('pond-transition');
                f.classList.remove('super-jump');
                startGameLogic();
            }, 1200);
        }, 500);
        return;
    }

    const q = config.qs[Math.floor(Math.random() * config.qs.length)];
    document.getElementById('q-text').innerHTML = `<b>–£—Ä–æ–≤–µ–Ω—å ${currentLevel}:</b> ${q.q}`;
    
    let options = [{t:q.a, ok:true}, {t:q.w1, ok:false}, {t:q.w2, ok:false}].sort(() => Math.random() - 0.5);
    const row = 5 - step;
    
    [1,2,3].forEach((c, i) => {
        const leaf = document.getElementById(`leaf-${row}-${c}`);
        leaf.classList.add('active');
        leaf.innerText = options[i].t;
        leaf.onclick = () => {
            if(options[i].ok) {
                playSnd(sounds.splash);
                updateFrog(leaf);
                lastCorrectLeaf = leaf;
                step++;
                setTimeout(loadLevel, 700);
            } else {
                handleError(leaf);
            }
        };
    });
    startTimer();
}

function handleError(leaf) {
    playSnd(sounds.shock);
    leaf.classList.add('shock');
    document.getElementById('frog').classList.add('shock');
    lives--;
    updateLives();
    
    setTimeout(() => {
        updateFrog(lastCorrectLeaf);
        leaf.classList.remove('shock');
        document.getElementById('frog').classList.remove('shock');
        if(lives <= 0) showEnd("–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê", false);
    }, 500);
}

function startTimer() {
    clearInterval(timer);
    let t = 100;
    timer = setInterval(() => {
        t -= 1;
        document.getElementById('timer-fill').style.width = t + '%';
        if(t <= 0) { clearInterval(timer); showEnd("–í–†–ï–ú–Ø –í–´–®–õ–û", false); }
    }, 150);
}

function showEnd(txt, win) {
    document.getElementById('overlay').style.display = 'flex';
    document.getElementById('msg').innerText = txt;
    if(win) playSnd(sounds.win); else playSnd(sounds.fail);
}
</script>
</body>
</html>
