<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Froggy Learning Game</title>
    <style>
        :root { --main-color: #6ab04c; --timer-color: #ff4757; }
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; background: #87CEEB; }
        #game-container { position: relative; width: 100vw; height: 100vh; background-size: cover; background-position: center; }
        #header { position: absolute; top: 0; width: 100%; height: 50px; background: var(--main-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 10; }
        #ui-layer { position: absolute; top: 60px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; z-index: 10; }
        #timer-bar { width: 200px; height: 20px; background: white; border-radius: 10px; overflow: hidden; border: 2px solid #333; }
        #timer-fill { width: 100%; height: 100%; background: var(--timer-color); transition: width 0.1s linear; }
        #lives { display: flex; gap: 5px; }
        .heart { width: 30px; height: 30px; background-size: contain; background-repeat: no-repeat; }
        #question-box { position: absolute; top: 120px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.95); padding: 20px; border-radius: 15px; text-align: center; width: 80%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 10; }
        #answers { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .btn-ans { padding: 12px; border: none; border-radius: 8px; background: #2f3542; color: white; cursor: pointer; font-size: 18px; transition: 0.2s; }
        .btn-ans:hover { transform: scale(1.02); }
        #frog { position: absolute; width: 100px; height: 100px; background-size: contain; background-repeat: no-repeat; z-index: 5; transition: all 0.5s ease; bottom: 50px; left: 50px; }
        .lily { position: absolute; width: 120px; height: 80px; background-size: contain; background-repeat: no-repeat; bottom: 40px; }
        .shock { animation: shake 0.2s infinite; filter: sepia(1) saturate(100) hue-rotate(190deg); }
        @keyframes shake { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(2px, -2px); } }
    </style>
</head>
<body>

<div id="game-container">
    <div id="header">ЗАГРУЗКА...</div>
    <div id="ui-layer">
        <div id="timer-bar"><div id="timer-fill"></div></div>
        <div id="lives"></div>
    </div>
    <div id="question-box">
        <div id="q-text" style="font-size: 22px; font-weight: bold;">Ожидание настроек из редактора...</div>
        <div id="answers"></div>
    </div>
    <div id="frog"></div>
</div>

<script>
let config = {};
let currentQ = 0;
let lives = 5;
let timeLeft = 15;
let timerInterval;
let bgMusic = new Audio();

// Слушаем редактор
window.addEventListener('message', (e) => {
    if (e.data.type === 'config') {
        config = e.data.settings;
        applySettings();
    }
});

function applySettings() {
    // Визуал
    document.getElementById('header').innerText = config.title;
    document.getElementById('header').style.background = config.colors.h;
    document.getElementById('game-container').style.backgroundImage = `url(${config.images.bg})`;
    document.getElementById('frog').style.backgroundImage = `url(${config.images.frog})`;
    document.getElementById('q-text').style.fontSize = config.fontSize + 'px';
    document.documentElement.style.setProperty('--timer-color', config.colors.t);
    
    // Сброс игры
    lives = parseInt(config.lives);
    currentQ = 0;
    updateLivesUI();
    
    // Звук
    if(config.audio.on) {
        bgMusic.src = config.audio.bg;
        bgMusic.volume = config.audio.vol;
        bgMusic.loop = true;
        bgMusic.play().catch(() => console.log("Кликните для звука"));
    } else {
        bgMusic.pause();
    }
    
    showQuestion();
}

function updateLivesUI() {
    const container = document.getElementById('lives');
    container.innerHTML = '';
    for(let i=0; i<lives; i++) {
        const h = document.createElement('div');
        h.className = 'heart';
        h.style.backgroundImage = `url(${config.images.heart})`;
        container.appendChild(h);
    }
}

function showQuestion() {
    if (currentQ >= config.questions.length) {
        alert(config.final.win);
        return;
    }

    const qData = config.questions[currentQ];
    document.getElementById('q-text').innerText = qData.q;
    const ansContainer = document.getElementById('answers');
    ansContainer.innerHTML = '';

    qData.a.forEach((text, index) => {
        const btn = document.createElement('button');
        btn.className = 'btn-ans';
        btn.innerText = text;
        btn.onclick = () => checkAnswer(index);
        ansContainer.appendChild(btn);
    });

    if(config.timerOn) startTimer();
}

function startTimer() {
    clearInterval(timerInterval);
    timeLeft = parseInt(config.timer);
    const fill = document.getElementById('timer-fill');
    timerInterval = setInterval(() => {
        timeLeft -= 0.1;
        fill.style.width = (timeLeft / config.timer) * 100 + '%';
        if(timeLeft <= 0) {
            clearInterval(timerInterval);
            handleWrong();
        }
    }, 100);
}

function checkAnswer(idx) {
    if(idx === config.questions[currentQ].correct) {
        playSound(config.audio.sndCorrect);
        currentQ++;
        moveFrog(true);
        showQuestion();
    } else {
        handleWrong();
    }
}

function handleWrong() {
    playSound(config.audio.sndError);
    lives--;
    updateLivesUI();
    
    // Эффект "удара током" и отскок назад
    const frog = document.getElementById('frog');
    frog.classList.add('shock');
    setTimeout(() => {
        frog.classList.remove('shock');
        moveFrog(false); // Прыжок назад
    }, 500);

    if(lives <= 0) {
        alert(config.final.lose);
        if(config.final.retry) location.reload();
    }
}

function moveFrog(forward) {
    const frog = document.getElementById('frog');
    let currentLeft = parseInt(frog.style.left) || 50;
    let nextPos = forward ? currentLeft + 150 : currentLeft - 50;
    frog.style.left = Math.max(50, nextPos) + 'px';
}

function playSound(url) {
    if(!config.audio.on) return;
    const s = new Audio(url);
    s.volume = config.audio.vol;
    s.play();
}
</script>
</body>
</html>
